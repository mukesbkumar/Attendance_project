import boto3
import urllib.parse

rekognition = boto3.client('rekognition')

COLLECTION_ID = 'attendance-collection'

def lambda_handler(event, context):
    bucket = event['Records'][0]['s3']['bucket']['name']
    key = urllib.parse.unquote_plus(event['Records'][0]['s3']['object']['key'])

    # Index faces in uploaded image to Rekognition collection
    response = rekognition.index_faces(
        CollectionId=COLLECTION_ID,
        Image={
            'S3Object': {
                'Bucket': bucket,
                'Name': key
            }
        },
        ExternalImageId=key.split('/')[-1].split('.')[0],  # e.g. filename as ExternalImageId
        DetectionAttributes=['DEFAULT']
    )

    print("IndexFaces response:", response)
